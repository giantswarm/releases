name: Announce Release

on:
  workflow_dispatch:
    inputs:
      provider_all:
        description: 'Include all providers'
        required: false
        type: boolean
        default: false
      provider_capa:
        description: 'Include AWS (CAPA) provider'
        required: false
        type: boolean
        default: false
      provider_capz:
        description: 'Include Azure (CAPZ) provider'
        required: false
        type: boolean
        default: false
      provider_cloud_director:
        description: 'Include Cloud Director (CAPVCD) provider'
        required: false
        type: boolean
        default: false
      provider_eks:
        description: 'Include EKS provider'
        required: false
        type: boolean
        default: false
      provider_vsphere:
        description: 'Include vSphere (CAPV) provider'
        required: false
        type: boolean
        default: false
      provider_test:
        description: 'Test provider (for testing)'
        required: false
        type: boolean
        default: false
      channel:
        type: string
        description: 'Send the notification to a single specified channel (testing)'
        required: false
      version:
        type: string
        description: 'Semver formatted version for the announcement being made'
        required: true

jobs:
  gather_channels:
    name: Gather channels
    runs-on: ubuntu-latest
    outputs:
      channels: ${{ steps.collect.outputs.channels }}
    env:
      GH_TOKEN: ${{ secrets.ANNOUNCE_NOTIFY_TOKEN }}
    steps:
      - name: Checkout installations code
        uses: actions/checkout@v6
        with:
          repository: giantswarm/installations
          path: installations
          ref: master
          token: ${{ secrets.ANNOUNCE_NOTIFY_TOKEN }}
      - name: Collect channels
        id: collect
        run: |
          INPUT_CHANNEL="${{ inputs.channel }}"
          PROVIDERS_ALL="${{ inputs.provider_all }}"
          
          # Build list of selected providers
          SELECTED_PROVIDERS=()
          if [[ "$PROVIDERS_ALL" == "true" ]]; then
             # If 'all' is selected, include real providers (exclude test)
             SELECTED_PROVIDERS+=("capa" "capz" "cloud-director" "vsphere" "eks")
          else
             [[ "${{ inputs.provider_capa }}" == "true" ]] && SELECTED_PROVIDERS+=("capa")
             [[ "${{ inputs.provider_capz }}" == "true" ]] && SELECTED_PROVIDERS+=("capz")
             [[ "${{ inputs.provider_cloud_director }}" == "true" ]] && SELECTED_PROVIDERS+=("cloud-director")
             [[ "${{ inputs.provider_vsphere }}" == "true" ]] && SELECTED_PROVIDERS+=("vsphere")
             [[ "${{ inputs.provider_eks }}" == "true" ]] && SELECTED_PROVIDERS+=("eks")
             [[ "${{ inputs.provider_test }}" == "true" ]] && SELECTED_PROVIDERS+=("test")
          fi

          slack_channels=()
          
          # Special handling for test provider
          if [[ " ${SELECTED_PROVIDERS[@]} " =~ " test " ]]; then
             if [[ -n "$INPUT_CHANNEL" ]]; then
                slack_channels+=("$INPUT_CHANNEL")
             else
                 # Fallback if no channel provided for test
                 slack_channels+=("test-capi-events") 
             fi
          fi

          # Collect channels for real providers
          # Only run installation search if we have real providers selected
          REAL_PROVIDERS_SELECTED=false
          for p in "${SELECTED_PROVIDERS[@]}"; do
            if [[ "$p" != "test" ]]; then
               REAL_PROVIDERS_SELECTED=true
               break
            fi
          done

          if [[ "$REAL_PROVIDERS_SELECTED" == "true" ]]; then
            # Default channels always included for real releases
            slack_channels+=("noise-releases" "sig-product")
            
            while read -r installation; do
              FILE_PATH="$installation/cluster.yaml"
              if [[ -f "$FILE_PATH" ]]; then
                INSTALLATION_PROVIDER=$(yq -r ".provider" $FILE_PATH)
                HAS_SLACK=$(yq 'has("slack")' $FILE_PATH)
                
                # Check if this installation's provider is in our selected list
                MATCHED_PROVIDER=false
                for selected in "${SELECTED_PROVIDERS[@]}"; do
                    if [[ "$selected" == "$INSTALLATION_PROVIDER" ]]; then
                       MATCHED_PROVIDER=true
                       break
                    fi
                done

                if [[ "$MATCHED_PROVIDER" == "true" ]]; then
                  if [[ "$HAS_SLACK" == "true" ]]; then
                    CHANNEL=$(yq -r '.slack.support[0]' "$FILE_PATH")
                    slack_channels+=("$CHANNEL")
                  fi
                fi
              fi
            done < <(find ./installations -type d -mindepth 1 -maxdepth 1)
          fi

          # Deduplicate channels and convert array to JSON string
          export OUTPUT_CHANNELS=$(printf '%s\n' "${slack_channels[@]}" | sort -u | jq -R . | jq -s -c .)
          echo "channels=$OUTPUT_CHANNELS" >> "$GITHUB_OUTPUT"
  
  get_announcement:
    name: Get announcement
    runs-on: ubuntu-latest
    outputs:
      announcement: ${{ steps.get_announcement_md.outputs.announcement }}
    steps:
      - name: Get announcement.md
        id: get_announcement_md
        run: |
          # We need to pick ONE provider to get the announcement text from.
          # Assuming the announcement text is the same for the version across providers,
          # or that we prioritize one if multiple are selected.
          # For simplicity, let's pick the first selected provider to construct the path.
          
          PROVIDERS_ALL="${{ inputs.provider_all }}"
          PROVIDER=""
          
          if [[ "$PROVIDERS_ALL" == "true" ]]; then
             PROVIDER="capa" # Default to capa if all are selected to find the file
          else
             [[ "${{ inputs.provider_capa }}" == "true" ]] && PROVIDER="capa"
             [[ "${{ inputs.provider_capz }}" == "true" ]] && PROVIDER="capz"
             [[ "${{ inputs.provider_cloud_director }}" == "true" ]] && PROVIDER="cloud-director"
             [[ "${{ inputs.provider_vsphere }}" == "true" ]] && PROVIDER="vsphere"
             [[ "${{ inputs.provider_eks }}" == "true" ]] && PROVIDER="eks"
             [[ "${{ inputs.provider_test }}" == "true" ]] && PROVIDER="test"
          fi
          
          if [[ -z "$PROVIDER" ]]; then
             echo "No provider selected"
             exit 1
          fi

          if [[ "$PROVIDER" == "test" ]]; then
            echo "This is a test announcement for version ${{ inputs.version }}" > announcement.md
          else
            if [[ "$PROVIDER" == "capz" ]]; then
              PROVIDER="azure"
            fi
            export LINK="https://raw.githubusercontent.com/giantswarm/releases/master/$PROVIDER/${{ inputs.version }}/announcement.md"
            wget $LINK
          fi
          echo "announcement<<EOF" >> "$GITHUB_OUTPUT"
          cat announcement.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
  
  send_messages:
    name: Send Messages
    runs-on: ubuntu-latest
    needs: [gather_channels, get_announcement]
    strategy:
      matrix: 
        channel: ${{ fromJSON(needs.gather_channels.outputs.channels) }}
    steps:
      - name: Write announcements
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ matrix.channel }}
            text: "${{ needs.get_announcement.outputs.announcement }}"

name: Update Release PR (Comment Trigger)

on:
  issue_comment:
    types: [created]

jobs:
  recreate:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/update-release') &&
      (github.actor == github.event.issue.user.login || contains(fromJson('["MEMBER", "OWNER", "COLLABORATOR"]'), github.event.author_association))
    runs-on: ubuntu-latest
    env:
      OPSCTL_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ github.event.comment.id }},
              content: 'rocket'
            })

      - name: Get PR branch name
        id: get_branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.issue.number }}
            });
            return pr.data.head.ref;

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get_branch.outputs.result }}

      - name: Parse command arguments
        id: parse_args
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          # Remove the command part and trim leading/trailing whitespace
          ARGS=$(echo "$COMMENT_BODY" | sed 's|^/update-release||' | xargs)
          echo "DEVCTL_ARGS=$ARGS" >> $GITHUB_OUTPUT

      - name: Parse branch name
        id: parse_branch
        run: |
          BRANCH_NAME="${{ steps.get_branch.outputs.result }}"
          if [[ $BRANCH_NAME == release-v*-* ]]; then
            # Minor/patch branch: release-v31.2.0-azure
            VERSION=$(echo $BRANCH_NAME | cut -d'-' -f2)
            PROVIDER=$(echo $BRANCH_NAME | cut -d'-' -f3)
            echo "IS_MAJOR=false" >> $GITHUB_OUTPUT
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
            echo "PROVIDER=$PROVIDER" >> $GITHUB_OUTPUT
          else
            # Major release branch: release-v32.0.0
            VERSION=$(echo $BRANCH_NAME | cut -d'-' -f2)
            echo "IS_MAJOR=true" >> $GITHUB_OUTPUT
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi
          
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Install devctl
        run: |
          LATEST_DEVCTL=$(gh release view --repo giantswarm/devctl --json tagName --jq '.tagName')
          go install github.com/giantswarm/devctl@${LATEST_DEVCTL}

      - name: Recreate release files
        run: |
          if [[ "${{ steps.parse_branch.outputs.IS_MAJOR }}" == "true" ]]; then
            # Major release: loop through all providers
            for provider in aws azure vsphere cloud-director; do
              echo "--- Recreating release for $provider ---"
              BASE_VERSION=$(./tools/determine-next-release.sh $provider major ${{ steps.parse_branch.outputs.VERSION }} | grep 'Base release:' | awk '{print $3}')
              devctl release create \
                --base $BASE_VERSION \
                --name ${{ steps.parse_branch.outputs.VERSION }} \
                --provider $provider \
                --bumpall --overwrite -y ${{ steps.parse_args.outputs.DEVCTL_ARGS }}
            done
          else
            # Minor/patch release for a single provider
            PROVIDER="${{ steps.parse_branch.outputs.PROVIDER }}"
            VERSION="${{ steps.parse_branch.outputs.VERSION }}"
            BASE_VERSION=$(./tools/determine-next-release.sh $PROVIDER "minor" $VERSION | grep 'Base release:' | awk '{print $3}')
            devctl release create \
              --base $BASE_VERSION \
              --name $VERSION \
              --provider $PROVIDER \
              --bumpall --overwrite -y ${{ steps.parse_args.outputs.DEVCTL_ARGS }}
          fi

      - name: Commit and push changes
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Recreate release files"
          branch: ${{ steps.get_branch.outputs.result }}
          # By not providing a title/body, the action will commit to the existing branch.
          
      - name: Add success reaction
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ github.event.comment.id }},
              content: '+1'
            })

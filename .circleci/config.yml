version: 2.1

# This config supports both automatic and manual triggering:
# - Automatic: When new release.yaml files are created on main/master, retag those charts
# - Manual: Trigger via CircleCI UI/API with provider and release_version parameters
#
# Manual trigger example via API:
#   curl -X POST https://circleci.com/api/v2/project/gh/giantswarm/releases/pipeline \
#     -H "Circle-Token: $CIRCLE_TOKEN" \
#     -H "Content-Type: application/json" \
#     -d '{"parameters": {"provider": "capa", "release_version": "v34.0.0"}}'
#
# TODO: Consider using the architect orb for chart building/pushing. The orb handles:
# - App Build Suite for chart building
# - Commit ID appending for versioning
# - GitHub token generation for OCI registry auth
# - Pushing to GitHub Pages catalogs (needed while App/Chart CRs are still in use)
# This would require triggering on Git tag creation instead of release.yaml changes.

parameters:
  provider:
    type: enum
    enum: ["", "capa", "azure", "vsphere", "cloud-director", "eks"]
    default: ""
  release_version:
    type: string
    default: ""

# Shared commands to avoid duplication between jobs
commands:
  install-tools:
    steps:
      - run:
          name: Install tools
          command: |
            # Install yq
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq

            # Install helm v4
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | DESIRED_VERSION=v4.0.0 bash

  login-oci-registry:
    steps:
      - run:
          name: Login to OCI registry
          command: |
            echo "${ACR_GSOCI_PASSWORD}" | helm registry login gsoci.azurecr.io \
              --username "${ACR_GSOCI_USERNAME}" \
              --password-stdin

  retag-and-push:
    # Reads from BASH_ENV: SOURCE_CHART, TARGET_CHART, CHART_VERSION, RELEASE_VERSION_CLEAN
    # Cannot use CircleCI parameters here because values are determined at runtime
    # (from parsing release.yaml), not at pipeline compile time.
    steps:
      - run:
          name: Pull, retag, and push chart
          command: |
            set -euo pipefail

            OCI_REGISTRY="gsoci.azurecr.io"
            OCI_PATH="charts/giantswarm"

            echo "=== Retagging ${SOURCE_CHART}:${CHART_VERSION} as ${TARGET_CHART}:${RELEASE_VERSION_CLEAN} ==="

            # Check if target chart already exists in the registry (avoid overwriting)
            if helm show chart "oci://${OCI_REGISTRY}/${OCI_PATH}/${TARGET_CHART}" --version "${RELEASE_VERSION_CLEAN}" >/dev/null 2>&1; then
              echo "${TARGET_CHART}:${RELEASE_VERSION_CLEAN} already exists in registry, skipping"
              exit 0
            fi

            WORK_DIR=$(mktemp -d)
            cd "${WORK_DIR}"

            echo "Pulling ${SOURCE_CHART}:${CHART_VERSION}..."
            helm pull "oci://${OCI_REGISTRY}/${OCI_PATH}/${SOURCE_CHART}" --version "${CHART_VERSION}"

            # Extract the chart
            tar -xzf "${SOURCE_CHART}-${CHART_VERSION}.tgz"

            # Rename chart directory
            mv "${SOURCE_CHART}" "${TARGET_CHART}"

            # Update Chart.yaml: change name and version
            yq -i ".name = \"${TARGET_CHART}\"" "${TARGET_CHART}/Chart.yaml"
            yq -i ".version = \"${RELEASE_VERSION_CLEAN}\"" "${TARGET_CHART}/Chart.yaml"

            # Inject global.release.version into values.yaml
            # This allows the cluster subchart to resolve the correct Release CR
            yq -i ".global.release.version = \"${RELEASE_VERSION_CLEAN}\"" "${TARGET_CHART}/values.yaml"

            # Verify the changes
            echo "Verification:"
            echo "  Chart name: $(yq '.name' "${TARGET_CHART}/Chart.yaml")"
            echo "  Chart version: $(yq '.version' "${TARGET_CHART}/Chart.yaml")"
            echo "  global.release.version: $(yq '.global.release.version' "${TARGET_CHART}/values.yaml")"

            # Repackage and push
            helm package "${TARGET_CHART}"
            helm push "${TARGET_CHART}-${RELEASE_VERSION_CLEAN}.tgz" "oci://${OCI_REGISTRY}/${OCI_PATH}"

            echo "Successfully pushed: oci://${OCI_REGISTRY}/${OCI_PATH}/${TARGET_CHART}:${RELEASE_VERSION_CLEAN}"

jobs:
  validate:
    docker:
      - image: quay.io/giantswarm/architect
    steps:
      - checkout
      - run:
          name: Validate releases
          command: CGO_ENABLED=0 go test ./...

  auto-retag:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - install-tools
      - run:
          name: Find new or updated releases
          command: |
            # Compare against the merge base to capture all commits in this push
            MERGE_BASE=$(git merge-base HEAD origin/master 2>/dev/null || git merge-base HEAD origin/main 2>/dev/null || echo "HEAD~1")
            CHANGED_FILES=$(git diff --name-only "${MERGE_BASE}" HEAD -- '*/v*.*.*/release.yaml' | grep -v '/archived/' || true)

            if [[ -z "${CHANGED_FILES}" ]]; then
              echo "No release.yaml files changed (excluding archived), skipping"
              echo "export RELEASES_TO_PROCESS=''" >> "$BASH_ENV"
              exit 0
            fi

            echo "Changed release.yaml files:"
            echo "${CHANGED_FILES}"

            # Extract provider/version pairs
            RELEASES=""
            for file in ${CHANGED_FILES}; do
              # Extract provider and version from path like "capa/v34.0.0/release.yaml"
              PROVIDER=$(echo "${file}" | cut -d'/' -f1)
              VERSION=$(echo "${file}" | cut -d'/' -f2)
              RELEASES="${RELEASES}${PROVIDER}:${VERSION} "
            done

            echo "Releases to process: ${RELEASES}"
            echo "export RELEASES_TO_PROCESS='${RELEASES}'" >> "$BASH_ENV"
      - login-oci-registry
      # NOTE: Cannot use the retag-and-push command here because CircleCI commands
      # are expanded at compile time (as steps), not at runtime. This job loops over
      # multiple releases in a single bash script, so the retag logic must be inline.
      - run:
          name: Retag changed releases
          command: |
            if [[ -z "${RELEASES_TO_PROCESS}" ]]; then
              echo "No releases to process"
              exit 0
            fi

            OCI_REGISTRY="gsoci.azurecr.io"
            OCI_PATH="charts/giantswarm"

            for release in ${RELEASES_TO_PROCESS}; do
              PROVIDER=$(echo "${release}" | cut -d':' -f1)
              RELEASE_VERSION=$(echo "${release}" | cut -d':' -f2)
              RELEASE_VERSION_CLEAN="${RELEASE_VERSION#v}"

              echo ""
              echo "=========================================="
              echo "Processing: ${PROVIDER} ${RELEASE_VERSION}"
              echo "=========================================="

              # Map provider directory to source and target chart names
              case "${PROVIDER}" in
                capa)
                  SOURCE_CHART="cluster-aws"
                  TARGET_CHART="release-aws"
                  ;;
                azure)
                  SOURCE_CHART="cluster-azure"
                  TARGET_CHART="release-azure"
                  ;;
                vsphere)
                  SOURCE_CHART="cluster-vsphere"
                  TARGET_CHART="release-vsphere"
                  ;;
                cloud-director)
                  SOURCE_CHART="cluster-cloud-director"
                  TARGET_CHART="release-cloud-director"
                  ;;
                eks)
                  SOURCE_CHART="cluster-eks"
                  TARGET_CHART="release-eks"
                  ;;
                *)
                  echo "Unknown provider: ${PROVIDER}, skipping"
                  continue
                  ;;
              esac

              RELEASE_PATH="${PROVIDER}/${RELEASE_VERSION}"

              # Check if release.yaml exists
              if [[ ! -f "${RELEASE_PATH}/release.yaml" ]]; then
                echo "Release file not found: ${RELEASE_PATH}/release.yaml, skipping"
                continue
              fi

              # Only retag active releases (skip deprecated/preview)
              RELEASE_STATE=$(yq '.spec.state' "${RELEASE_PATH}/release.yaml")
              if [[ "${RELEASE_STATE}" != "active" ]]; then
                echo "Release state is '${RELEASE_STATE}' (not active), skipping"
                continue
              fi

              # Extract cluster chart version from release.yaml
              CHART_VERSION=$(yq ".spec.components[] | select(.name == \"${SOURCE_CHART}\") | .version" "${RELEASE_PATH}/release.yaml")

              if [[ -z "${CHART_VERSION}" || "${CHART_VERSION}" == "null" ]]; then
                echo "Could not find ${SOURCE_CHART} version in release.yaml, skipping"
                continue
              fi

              echo "  Source chart: ${SOURCE_CHART}:${CHART_VERSION}"
              echo "  Target chart: ${TARGET_CHART}:${RELEASE_VERSION_CLEAN}"

              # Check if target chart already exists in the registry (avoid overwriting)
              if helm show chart "oci://${OCI_REGISTRY}/${OCI_PATH}/${TARGET_CHART}" --version "${RELEASE_VERSION_CLEAN}" >/dev/null 2>&1; then
                echo "  ${TARGET_CHART}:${RELEASE_VERSION_CLEAN} already exists in registry, skipping"
                continue
              fi

              WORK_DIR=$(mktemp -d)
              cd "${WORK_DIR}"

              # Pull original chart
              helm pull "oci://${OCI_REGISTRY}/${OCI_PATH}/${SOURCE_CHART}" --version "${CHART_VERSION}"

              # Extract the chart
              tar -xzf "${SOURCE_CHART}-${CHART_VERSION}.tgz"

              # Rename chart directory
              mv "${SOURCE_CHART}" "${TARGET_CHART}"

              # Update Chart.yaml: change name and version
              yq -i ".name = \"${TARGET_CHART}\"" "${TARGET_CHART}/Chart.yaml"
              yq -i ".version = \"${RELEASE_VERSION_CLEAN}\"" "${TARGET_CHART}/Chart.yaml"

              # Inject global.release.version into values.yaml
              yq -i ".global.release.version = \"${RELEASE_VERSION_CLEAN}\"" "${TARGET_CHART}/values.yaml"

              # Repackage and push
              helm package "${TARGET_CHART}"
              helm push "${TARGET_CHART}-${RELEASE_VERSION_CLEAN}.tgz" "oci://${OCI_REGISTRY}/${OCI_PATH}"

              echo "Successfully pushed: oci://${OCI_REGISTRY}/${OCI_PATH}/${TARGET_CHART}:${RELEASE_VERSION_CLEAN}"

              cd -
              rm -rf "${WORK_DIR}"
            done

            echo ""
            echo "=========================================="
            echo "All releases processed"
            echo "=========================================="

  retag-chart:
    docker:
      - image: cimg/base:current
    parameters:
      provider:
        type: string
      release_version:
        type: string
    steps:
      - checkout
      - install-tools
      - run:
          name: Parse release information
          command: |
            PROVIDER="<< parameters.provider >>"
            RELEASE_VERSION="<< parameters.release_version >>"
            RELEASE_VERSION_CLEAN="${RELEASE_VERSION#v}"

            # Map provider directory to source and target chart names
            case "${PROVIDER}" in
              capa)
                SOURCE_CHART="cluster-aws"
                TARGET_CHART="release-aws"
                ;;
              azure)
                SOURCE_CHART="cluster-azure"
                TARGET_CHART="release-azure"
                ;;
              vsphere)
                SOURCE_CHART="cluster-vsphere"
                TARGET_CHART="release-vsphere"
                ;;
              cloud-director)
                SOURCE_CHART="cluster-cloud-director"
                TARGET_CHART="release-cloud-director"
                ;;
              eks)
                SOURCE_CHART="cluster-eks"
                TARGET_CHART="release-eks"
                ;;
              *)
                echo "Unknown provider: ${PROVIDER}"
                exit 1
                ;;
            esac

            RELEASE_PATH="${PROVIDER}/${RELEASE_VERSION}"

            # Check if release.yaml exists
            if [[ ! -f "${RELEASE_PATH}/release.yaml" ]]; then
              echo "Release file not found: ${RELEASE_PATH}/release.yaml"
              exit 1
            fi

            # Extract cluster chart version from release.yaml
            CHART_VERSION=$(yq ".spec.components[] | select(.name == \"${SOURCE_CHART}\") | .version" "${RELEASE_PATH}/release.yaml")

            if [[ -z "${CHART_VERSION}" || "${CHART_VERSION}" == "null" ]]; then
              echo "Could not find ${SOURCE_CHART} version in release.yaml"
              exit 1
            fi

            echo "Summary:"
            echo "  Provider: ${PROVIDER}"
            echo "  Release Version: ${RELEASE_VERSION}"
            echo "  Source Chart: ${SOURCE_CHART}:${CHART_VERSION}"
            echo "  Target Chart: ${TARGET_CHART}:${RELEASE_VERSION_CLEAN}"

            # Export for subsequent steps
            echo "export PROVIDER='${PROVIDER}'" >> "$BASH_ENV"
            echo "export RELEASE_VERSION='${RELEASE_VERSION}'" >> "$BASH_ENV"
            echo "export RELEASE_VERSION_CLEAN='${RELEASE_VERSION_CLEAN}'" >> "$BASH_ENV"
            echo "export SOURCE_CHART='${SOURCE_CHART}'" >> "$BASH_ENV"
            echo "export TARGET_CHART='${TARGET_CHART}'" >> "$BASH_ENV"
            echo "export CHART_VERSION='${CHART_VERSION}'" >> "$BASH_ENV"
      - login-oci-registry
      - retag-and-push

workflows:
  # Runs on all branches - validates release structure
  validate:
    when:
      equal: ["", << pipeline.parameters.provider >>]
    jobs:
      - validate

  # Runs on main/master only - auto-retags changed releases
  auto-retag:
    when:
      equal: ["", << pipeline.parameters.provider >>]
    jobs:
      - auto-retag:
          context: architect
          filters:
            branches:
              only:
                - main
                - master

  # Manual trigger - retag a specific release
  retag-chart:
    when:
      not:
        equal: ["", << pipeline.parameters.provider >>]
    jobs:
      - retag-chart:
          context: architect
          provider: << pipeline.parameters.provider >>
          release_version: << pipeline.parameters.release_version >>

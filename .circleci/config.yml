version: 2.1

orbs:
  architect: giantswarm/architect@6.12.0

# This config supports both automatic and manual triggering:
# - Automatic: When new release.yaml files are created on main/master, retag those charts
# - Manual: Trigger via CircleCI UI/API with provider and release_version parameters
#
# Manual trigger example via API:
#   curl -X POST https://circleci.com/api/v2/project/gh/giantswarm/releases/pipeline \
#     -H "Circle-Token: $CIRCLE_TOKEN" \
#     -H "Content-Type: application/json" \
#     -d '{"parameters": {"provider": "capa", "release_version": "v34.0.0"}}'
#
# Charts are pushed to both OCI registry (gsoci.azurecr.io) and GitHub Pages
# catalog (cluster-catalog) using the architect orb. App Build Suite adds
# metadata and validation. GitHub Pages push is required while App/Chart CRs
# are still in use (App Operator can't consume OCI registries directly).

parameters:
  provider:
    type: enum
    enum: ["", "capa", "azure", "vsphere", "cloud-director", "eks"]
    default: ""
  release_version:
    type: string
    default: ""

commands:
  install-yq:
    steps:
      - run:
          name: Install yq
          command: |
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq

  login-oci-registry:
    # Required for helm pull from gsoci.azurecr.io (push is handled by architect/push-helm)
    steps:
      - run:
          name: Login to OCI registry
          command: |
            echo "${ACR_GSOCI_PASSWORD}" | helm registry login gsoci.azurecr.io \
              --username "${ACR_GSOCI_USERNAME}" \
              --password-stdin

jobs:
  validate:
    docker:
      - image: quay.io/giantswarm/architect
    steps:
      - checkout
      - run:
          name: Validate releases
          command: CGO_ENABLED=0 go test ./...

  auto-retag:
    executor: architect/app-build-suite
    steps:
      - checkout
      - install-yq
      - run:
          name: Find new or updated releases
          command: |
            # Compare against the merge base to capture all commits in this push
            MERGE_BASE=$(git merge-base HEAD origin/master 2>/dev/null || git merge-base HEAD origin/main 2>/dev/null || echo "HEAD~1")
            CHANGED_FILES=$(git diff --name-only "${MERGE_BASE}" HEAD -- '*/v*.*.*/release.yaml' | grep -v '/archived/' || true)

            if [[ -z "${CHANGED_FILES}" ]]; then
              echo "No release.yaml files changed (excluding archived), skipping"
              circleci-agent step halt
            fi

            echo "Changed release.yaml files:"
            echo "${CHANGED_FILES}"

            # Extract provider/version pairs
            RELEASES=""
            for file in ${CHANGED_FILES}; do
              # Extract provider and version from path like "capa/v34.0.0/release.yaml"
              PROVIDER=$(echo "${file}" | cut -d'/' -f1)
              VERSION=$(echo "${file}" | cut -d'/' -f2)
              RELEASES="${RELEASES}${PROVIDER}:${VERSION} "
            done

            echo "Releases to process: ${RELEASES}"
            echo "export RELEASES_TO_PROCESS='${RELEASES}'" >> "$BASH_ENV"
      - login-oci-registry
      - run:
          name: Retag changed releases
          command: |
            set -euo pipefail

            OCI_REGISTRY="gsoci.azurecr.io"
            OCI_PATH="charts/giantswarm"
            mkdir -p build

            # Write catalog name for ABS metadata generation
            echo -n "cluster-catalog" > .app_catalog_name

            for release in ${RELEASES_TO_PROCESS}; do
              PROVIDER=$(echo "${release}" | cut -d':' -f1)
              RELEASE_VERSION=$(echo "${release}" | cut -d':' -f2)
              RELEASE_VERSION_CLEAN="${RELEASE_VERSION#v}"

              echo ""
              echo "=========================================="
              echo "Processing: ${PROVIDER} ${RELEASE_VERSION}"
              echo "=========================================="

              # Map provider directory to source and target chart names
              case "${PROVIDER}" in
                capa)
                  SOURCE_CHART="cluster-aws"
                  TARGET_CHART="release-aws"
                  ;;
                azure)
                  SOURCE_CHART="cluster-azure"
                  TARGET_CHART="release-azure"
                  ;;
                vsphere)
                  SOURCE_CHART="cluster-vsphere"
                  TARGET_CHART="release-vsphere"
                  ;;
                cloud-director)
                  SOURCE_CHART="cluster-cloud-director"
                  TARGET_CHART="release-cloud-director"
                  ;;
                eks)
                  SOURCE_CHART="cluster-eks"
                  TARGET_CHART="release-eks"
                  ;;
                *)
                  echo "Unknown provider: ${PROVIDER}, skipping"
                  continue
                  ;;
              esac

              RELEASE_PATH="${PROVIDER}/${RELEASE_VERSION}"

              # Check if release.yaml exists
              if [[ ! -f "${RELEASE_PATH}/release.yaml" ]]; then
                echo "Release file not found: ${RELEASE_PATH}/release.yaml, skipping"
                continue
              fi

              # Only retag active releases (skip deprecated/preview)
              RELEASE_STATE=$(yq '.spec.state' "${RELEASE_PATH}/release.yaml")
              if [[ "${RELEASE_STATE}" != "active" ]]; then
                echo "Release state is '${RELEASE_STATE}' (not active), skipping"
                continue
              fi

              # Extract cluster chart version from release.yaml
              CHART_VERSION=$(yq ".spec.components[] | select(.name == \"${SOURCE_CHART}\") | .version" "${RELEASE_PATH}/release.yaml")

              if [[ -z "${CHART_VERSION}" || "${CHART_VERSION}" == "null" ]]; then
                echo "Could not find ${SOURCE_CHART} version in release.yaml, skipping"
                continue
              fi

              echo "  Source chart: ${SOURCE_CHART}:${CHART_VERSION}"
              echo "  Target chart: ${TARGET_CHART}:${RELEASE_VERSION_CLEAN}"

              # Check if target chart already exists in the registry (avoid overwriting)
              if helm show chart "oci://${OCI_REGISTRY}/${OCI_PATH}/${TARGET_CHART}" --version "${RELEASE_VERSION_CLEAN}" >/dev/null 2>&1; then
                echo "  ${TARGET_CHART}:${RELEASE_VERSION_CLEAN} already exists in registry, skipping"
                continue
              fi

              WORK_DIR=$(mktemp -d)
              cd "${WORK_DIR}"

              # Pull original chart
              helm pull "oci://${OCI_REGISTRY}/${OCI_PATH}/${SOURCE_CHART}" --version "${CHART_VERSION}"

              # Extract, rename, and modify
              tar -xzf "${SOURCE_CHART}-${CHART_VERSION}.tgz"
              mv "${SOURCE_CHART}" "${TARGET_CHART}"
              yq -i ".name = \"${TARGET_CHART}\"" "${TARGET_CHART}/Chart.yaml"
              yq -i ".version = \"${RELEASE_VERSION_CLEAN}\"" "${TARGET_CHART}/Chart.yaml"
              yq -i ".global.release.version = \"${RELEASE_VERSION_CLEAN}\"" "${TARGET_CHART}/values.yaml"

              # Place in helm/ for ABS and run App Build Suite
              mkdir -p ~/project/helm
              rm -rf ~/project/helm/release-chart
              mv "${TARGET_CHART}" ~/project/helm/release-chart
              cd ~/project

              python -m app_build_suite \
                --chart-dir ./helm/release-chart \
                --destination build \
                --generate-metadata \
                --catalog-base-url "https://giantswarm.github.io/cluster-catalog/" \
                --keep-chart-changes

              rm -rf helm/release-chart
              rm -rf "${WORK_DIR}"

              echo "Packaged: ${TARGET_CHART}:${RELEASE_VERSION_CLEAN}"
            done

            echo ""
            echo "=========================================="
            echo "All releases processed"
            echo "=========================================="
      - run:
          name: Check if charts were packaged
          command: |
            if ! ls build/*.tgz >/dev/null 2>&1; then
              echo "No charts to push (all already exist or none found)"
              circleci-agent step halt
            fi
            echo "Charts to push:"
            ls -la build/*.tgz
            echo -n "cluster-catalog" > .app_catalog_name
            echo -n "${CIRCLE_SHA1}" > .reference
      - architect/push-helm:
          chart: release-chart
          push_to_appcatalog: true
          push_to_oci_registry: true
          force-public: true

  prepare-retag-chart:
    executor: architect/app-build-suite
    parameters:
      provider:
        type: string
      release_version:
        type: string
    steps:
      - checkout
      - install-yq
      - run:
          name: Parse release information
          command: |
            PROVIDER="<< parameters.provider >>"
            RELEASE_VERSION="<< parameters.release_version >>"
            RELEASE_VERSION_CLEAN="${RELEASE_VERSION#v}"

            # Map provider directory to source and target chart names
            case "${PROVIDER}" in
              capa)
                SOURCE_CHART="cluster-aws"
                TARGET_CHART="release-aws"
                ;;
              azure)
                SOURCE_CHART="cluster-azure"
                TARGET_CHART="release-azure"
                ;;
              vsphere)
                SOURCE_CHART="cluster-vsphere"
                TARGET_CHART="release-vsphere"
                ;;
              cloud-director)
                SOURCE_CHART="cluster-cloud-director"
                TARGET_CHART="release-cloud-director"
                ;;
              eks)
                SOURCE_CHART="cluster-eks"
                TARGET_CHART="release-eks"
                ;;
              *)
                echo "Unknown provider: ${PROVIDER}"
                exit 1
                ;;
            esac

            RELEASE_PATH="${PROVIDER}/${RELEASE_VERSION}"

            # Check if release.yaml exists
            if [[ ! -f "${RELEASE_PATH}/release.yaml" ]]; then
              echo "Release file not found: ${RELEASE_PATH}/release.yaml"
              exit 1
            fi

            # Extract cluster chart version from release.yaml
            CHART_VERSION=$(yq ".spec.components[] | select(.name == \"${SOURCE_CHART}\") | .version" "${RELEASE_PATH}/release.yaml")

            if [[ -z "${CHART_VERSION}" || "${CHART_VERSION}" == "null" ]]; then
              echo "Could not find ${SOURCE_CHART} version in release.yaml"
              exit 1
            fi

            echo "Summary:"
            echo "  Provider: ${PROVIDER}"
            echo "  Release Version: ${RELEASE_VERSION}"
            echo "  Source Chart: ${SOURCE_CHART}:${CHART_VERSION}"
            echo "  Target Chart: ${TARGET_CHART}:${RELEASE_VERSION_CLEAN}"

            # Export for subsequent steps
            echo "export SOURCE_CHART='${SOURCE_CHART}'" >> "$BASH_ENV"
            echo "export TARGET_CHART='${TARGET_CHART}'" >> "$BASH_ENV"
            echo "export CHART_VERSION='${CHART_VERSION}'" >> "$BASH_ENV"
            echo "export RELEASE_VERSION_CLEAN='${RELEASE_VERSION_CLEAN}'" >> "$BASH_ENV"
      - login-oci-registry
      - run:
          name: Check if chart already exists
          command: |
            if helm show chart "oci://gsoci.azurecr.io/charts/giantswarm/${TARGET_CHART}" --version "${RELEASE_VERSION_CLEAN}" >/dev/null 2>&1; then
              echo "${TARGET_CHART}:${RELEASE_VERSION_CLEAN} already exists in registry, skipping"
              circleci-agent step halt
            fi
      - run:
          name: Pull and retag chart
          command: |
            set -euo pipefail

            WORK_DIR=$(mktemp -d)
            cd "${WORK_DIR}"

            echo "Pulling ${SOURCE_CHART}:${CHART_VERSION}..."
            helm pull "oci://gsoci.azurecr.io/charts/giantswarm/${SOURCE_CHART}" --version "${CHART_VERSION}"

            # Extract, rename, and modify
            tar -xzf "${SOURCE_CHART}-${CHART_VERSION}.tgz"
            mv "${SOURCE_CHART}" "${TARGET_CHART}"

            yq -i ".name = \"${TARGET_CHART}\"" "${TARGET_CHART}/Chart.yaml"
            yq -i ".version = \"${RELEASE_VERSION_CLEAN}\"" "${TARGET_CHART}/Chart.yaml"
            yq -i ".global.release.version = \"${RELEASE_VERSION_CLEAN}\"" "${TARGET_CHART}/values.yaml"

            echo "Verification:"
            echo "  Chart name: $(yq '.name' "${TARGET_CHART}/Chart.yaml")"
            echo "  Chart version: $(yq '.version' "${TARGET_CHART}/Chart.yaml")"
            echo "  global.release.version: $(yq '.global.release.version' "${TARGET_CHART}/values.yaml")"

            # Place in helm/release-chart/ for the push-to-app-catalog job
            mkdir -p ~/project/helm
            mv "${TARGET_CHART}" ~/project/helm/release-chart
      - persist_to_workspace:
          root: .
          paths:
            - helm/release-chart

workflows:
  # Runs on all branches - validates release structure
  validate:
    when:
      equal: ["", << pipeline.parameters.provider >>]
    jobs:
      - validate

  # Runs on main/master only - auto-retags changed releases
  auto-retag:
    when:
      equal: ["", << pipeline.parameters.provider >>]
    jobs:
      - auto-retag:
          context: architect
          filters:
            branches:
              only:
                - main
                - master

  # Manual trigger - retag a specific release
  retag-chart:
    when:
      not:
        equal: ["", << pipeline.parameters.provider >>]
    jobs:
      - prepare-retag-chart:
          context: architect
          provider: << pipeline.parameters.provider >>
          release_version: << pipeline.parameters.release_version >>
      - architect/push-to-app-catalog:
          name: push-retag-chart
          context: architect
          requires:
            - prepare-retag-chart
          attach_workspace: true
          chart: release-chart
          explicit_allow_chart_name_mismatch: true
          executor: app-build-suite
          app_catalog: cluster-catalog
          app_catalog_test: cluster-catalog
          push_to_appcatalog: true
          push_to_oci_registry: true
          force-public: true
          on_tag: false
